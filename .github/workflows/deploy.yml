name: "Deploy playbook"
on:
  pull_request:
    types: closed

jobs:
  Get_env:
    runs-on:
      - self-hosted
    outputs:
      env_vars: ${{ steps.env_vars.outputs.env_vars }}
    steps:
      - name: Find tags
        run: |
          echo "DEPLOY_TAGS=`echo '${{ github.event.head_commit.message }}' | awk '/Deploy-Tags/ {$1="";print}'`" >> $GITHUB_ENV
          echo "TEST_TAGS=`echo '${{ github.event.head_commit.message }}' | awk '/Test-Tags/ {$1="";print}'`" >> $GITHUB_ENV

      - name: Print env var
        run: |
          echo "::set-output name=env_vars::$(echo $(jq -n 'env'))"
        id: env_vars
  Deploy:
    needs: Get_env
    if: ${{ github.ref_name == github.event.repository.default_branch && github.event.pull_request.merged == true && fromJson(needs.Get_env.outputs.env_vars).DEPLOY_TAGS != '' }}
    runs-on: self-hosted
    steps:
      - name: Deploy shared
        run: echo "Deployment"
